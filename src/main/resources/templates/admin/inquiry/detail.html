<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <title>답변 수정</title>

</head>
<body>

    <div th:fragment="inquiryDetail" class="container my-5">
        <h2 class="mb-3">문의글 내용</h2>
        <form th:action="@{/admin/inquiry/detail}" method="post" enctype="multipart/form-data" class="row g-3 needs-validation" novalidate>
            <label class="form-label">문의 제목</label><input type="text" style="width: 500px" name="inquiryTitle" class="form-control" th:value="${ inquiry.inquiryTitle }" readonly><br>
            <label class="form-label">문의 내용</label><input type="text" style="text-align: center; width: 500px; height: 500px;" name="inquiryDetail" class="form-control" th:value="${ inquiry.inquiryDetail }" readonly><br>
        </form>

        <form th:action="@{/admin/inquiry/delete/{code}(code=${ inquiry.inquiryCode })}" method="post">
            <button type="submit" class="btn btn-danger btn-block mt-3">삭제</button>
        </form>

        <div th:if="${reply != null}" class="reply-container mt-4">
            <h6 class="text-success">답변</h6>
            <p><strong>답변 코드 : </strong><span th:text="${reply.replyCode}"></span></p>
            <p><strong>답변 내용 : </strong><span th:text="${reply.replyDetail}"></span></p>
            <p><strong>답변 날짜 : </strong><span th:text="${reply.replyDate}"></span></p>

        <form th:action="@{updateReply}" method="post">
            <div class="mb-3">
                <label for="replyDetail" class="form-label">수정할 답변 내용 : </label>
                <textarea id="replyDetail" name="replyDetail" class="form-control" rows="10"
                          th:value="${reply.replyDetail}" required style="text-align:left; letter-spacing: 2px;"></textarea>
                <div class="invalid-feedback">내용을 입력해주세요.</div>
            </div>
        </form>

        <div class="col-12 text-end">
            <button type="submit" class="btn btn-primary">수정하기</button>
            <button type="submit" class="btn btn-danger" onclick="confirmDelete()">삭제하기</button>
        </div>
        </div>
    </div>

    <div th:if="${reply == null}" class="reply-container mt-4">
        <form th:action="@{registReply}" method="post">
            <label class="form-label">답변 내용 : </label>
            <label>
                <textarea name="replyDetail" class="form-control" th:value="${reply.replyDetail}"></textarea>
            </label>
            <button type="submit" class="submit-btn">등록</button>
        </form>
    </div>

    <div>
        <form th:action="@{/deleteReply/{code}(code=${reply.getReplyCode})}" method="post" id="deleteForm">
            <input type="hidden" name="replyCode" th:value="${reply.replyCode}">
        </form>

        <script>
            // Form validation using Bootstrap
            (() => {
                'use strict';

                // Fetch all the forms we want to apply custom Bootstrap validation styles to
                const forms = document.querySelectorAll('.needs-validation');

                // Loop over them and prevent submission
                Array.from(forms).forEach(form => {
                    form.addEventListener('submit', event => {
                        if (!form.checkValidity()) {
                            event.preventDefault();
                            event.stopPropagation();
                        }

                        form.classList.add('was-validated');
                    }, false);
                });
            })();

            document.addEventListener('DOMContentLoaded', function () {
                const currentInquiryCode = `[[${inquiry.inquiryCode}]]`;
                // 문의글 데이터를 비동기로 가져오기
                fetch("/admin/inquiry/list")
                    .then(res => {
                        if (!res.ok) {
                            throw new Error('서버 응답 에러: ' + res.status);
                        }
                        return res.json();
                    })
                    .then(data => {
                        const inquiryCodeSelect = document.getElementById('inquiryCode');

                        // 문의글 데이터가 있는지 확인
                        if (data.length === 0) {
                            console.error("문의글 데이터가 없습니다.");
                            return;
                        }

                        // 데이터를 기반으로 옵션 생성
                        data.forEach(inquiry => {
                            const option = document.createElement('option');
                            option.value = inquiry.inquiryCode;
                            option.textContent = inquiry.inquiryCode;

                            if (inquiry.inquiryCode.toString() === currentInquiryCode.toString()) {
                                option.selected = true;
                            }

                            inquiryCodeSelect.appendChild(option);
                        });

                        inquiryCodeSelect.value = currentInquiryCode;
                    })
                    .catch(error => {
                        console.error('문의글을 불러오는 중 오류 발생:', error);
                    });
            });
            // 삭제 confirm
            function confirmDelete() {
                if (confirm("정말로 이 답변을 삭제하시겠습니까?")) {
                    document.getElementById('deleteForm').submit();
                }
            }
            // // 수정 confirm
            // function confirmUpdate() {
            //     if (confirm("답변을 수정하시겠습니까?")) {
            //         document.getElementById('updateForm').submit();
            //     }
            // }
        </script>
    </div>

</body>
</html>